<!DOCTYPE html>
<html>

<head>
  <title>
    <%= title %>
  </title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    html,
    body {
      min-height: 100%;
      margin: 0;
      padding: 0;
      overflow-y: auto;
    }

    .table-responsive {
      overflow: visible !important;
    }

    #todoContainer .alert {
      padding: 10px 15px;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">
    <h1 class="h4 mb-4">
      <%= title %>
    </h1>

    <!-- Filter Form -->
    <form id="filterForm" class="card shadow-sm mb-4 p-3">
      <input type="hidden" name="page" value="1">

      <div class="row mb-3 align-items-center">
        <label class="col-sm-2 col-form-label text-start">Title</label>
        <div class="col-sm-10">
          <input type="text" name="string" class="form-control" placeholder="Search title">
        </div>
      </div>
      <div class="row mb-3 align-items-center">
        <label class="col-sm-2 col-form-label text-start">Deadline</label>
        <div class="col-sm-10">
          <div class="d-flex gap-2">
            <input type="date" name="startdate" class="form-control">
            <span>s.d.</span>
            <input type="date" name="enddate" class="form-control">
          </div>
        </div>
      </div>

      <div class="row mb-3 align-items-center">
        <label class="col-sm-2 col-form-label text-start">Complete</label>
        <div class="col-sm-10">
          <select name="boolean" class="form-select">
            <option value="">-select complete-</option>
            <option value="true">Yes</option>
            <option value="false">Not Yet</option>
          </select>
        </div>
      </div>

      <div class="d-flex gap-5 justify-content-start align-items-center mb-3">
        <button id="sortDeadlineBtn" class="btn btn-success">
          <i id="sortIcon" class="fa fa-sort"></i>
          Sort by Deadline
        </button>
        <div class="d-flex gap-1">
          <button type="submit" class="btn btn-primary"><i class="fa fa-search"></i></button>
          <button type="button" id="resetBtn" class="btn btn-warning"><i class="fa fa-refresh"></i></button>
        </div>
      </div>
    </form>

    <!-- Add New Todo -->
    <form id="addTodoForm" class="card shadow-sm mb-3 p-2">
      <div class="input-group">
        <input type="text" name="title" class="form-control" placeholder="title">
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-arrow-down"></i>
        </button>
      </div>
    </form>

    <!-- Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div id="todoContainer" class="d-flex flex-column gap-2"></div>
        <!-- Spinner -->
        <div id="loading" class="text-center my-3" style="display:none;">
          <div class="spinner-border" role="status"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- edit modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editForm">
          <div class="modal-header">
            <h5 class="modal-title">Edit Todos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editId">
            <div class="mb-3">
              <label class="form-label"> Title</label>
              <input type="text" id="editTitle" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label"> Deadline</label>
              <input type="date" id="editDeadline" class="form-control" required>
            </div>

            <div class="mb-3 form-check">
              <input type="checkbox" id="editComplete" class="form-check-input">
              <label class="form-check-label" for="editComplete">Done</label>
            </div>


            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
        </form>
      </div>
    </div>
  </div>


  <!-- Delete Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure want to delete <span id="deleteItem"></span>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <form id="deleteForm" method="POST">
            <button type="submit" class="btn btn-warning">Yes</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const userId = "<%= userId %>";
    let page = 1;
    let loading = false;
    let finished = false;
    let sortMode = 'asc';
    let FormData = {};


    // Load todos
    function loadTodos(params = {}) {
      if (loading || finished) return;
      loading = true;
      $("#loading").show();

      const query = $.param({ ...params, page });

      $.get(`/todos/user/${userId}?${query}`, function (res) {
        if (res.data.length === 0) {
          finished = true;
          $("#loading").hide();
          return;
        }

        let alerts = "";
        res.data.forEach((todo, idx) => {
          let alertClass = "alert-secondary";
          if (!todo.complete && new Date(todo.deadline) < new Date()) {
            alertClass = "alert-danger";
          } else if (todo.complete) {
            alertClass = "alert-success";
          }

          alerts += `
            <div class="alert ${alertClass} d-flex justify-content-between align-items-center">
              <div>
                <small>${todo.deadlineFormatted}</small>
                <small>${todo.title}</small>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-success editBtn"
                  data-id="${todo._id}"
                  data-title="${todo.title}"
                  data-deadline="${todo.deadline}"
                  data-complete="${todo.complete}">
                  <i class="fa fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-danger deleteBtn"
                  data-id ="${todo._id}"
                  data-title="${todo.title}">
                  <i class="fa fa-trash"></i>
                    </button>
                   </div>
                  </div>`;
        });

        $("#todoContainer").append(alerts);
        page++;
        loading = false;
        $("#loading").hide();
      });
    }

    // Infinite scroll
    $(window).on("scroll", function () {
      if ($(window).scrollTop() + $(window).height() >= $(document).height() - 50) {
        $("#filterForm").serializeArray().forEach(item => {
          if (item.value.trim() !== "") FormData[item.name] = item.value.trim();
        })
        loadTodos({ ...FormData, sortBy: 'deadline', sortMode: sortMode })
      }
    });

    // sorting 
    $("#sortDeadlineBtn").click(function (e) {
      e.preventDefault();
      sortMode = sortMode === 'asc' ? 'desc' : 'asc';

      page = 1;
      finished = false;
      $("#todoContainer").empty();

      loadTodos({ sortBy: 'deadline', sortMode: sortMode })

      $("#sortIcon").removeClass("fa-sort fa-sort-up fa-sort-down");
      $("#sortIcon").addClass(sortMode === 'asc' ? 'fa-sort-up' : 'fa-sort-down')

    });

    // Filter submit
    $("#filterForm").on("submit", function (e) {
      e.preventDefault();
      page = 1;
      finished = false;
      $("#todoContainer").empty();
      FormData = {}; //clear
      $(this).serializeArray().forEach(item => {
        if (item.value.trim() !== "") FormData[item.name] = item.value.trim();
      });
      loadTodos({ ...FormData, sortBy: 'deadline', sortMode: sortMode })
    });

    // Reset filter
    $("#resetBtn").click(function () {

      $("#filterForm")[0].reset();

      page = 1;
      finished = false;
      sortMode = 'asc';
      $("#todoContainer").empty();
      $("#sortIcon").attr("class", "fa fa-sort");
      loadTodos();
    });

    // ADD form
    $("#addTodoForm").on("submit", function (e) {
      e.preventDefault()

      const title = $(this).find("input[name='title']").val().trim();

      if (!title) {
        alert("title is required");
        return;
      }
      $.ajax({
        url: "/todos",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          title: title,
          executor: userId
        }),
        success: function (res) {
          console.log("todo added: ", res);

          $("#addTodoForm")[0].reset()

          page = 1;
          finished = false;
          $("#todoContainer").empty();
          loadTodos({ sortBy: 'deadline', sortMode: sortMode })

        },
        error: function (err) {
          alert("failed to add todo: " + (err.responseJSON?.error || err.status))
        }
      })
    })

    // edit modal
    $(document).on("click", ".editBtn", function () {
      const id = $(this).data("id");
      const title = $(this).data("title");
      const deadline = $(this).data("deadline");
      const complete = $(this).data("complete");

      $("#editId").val(id)
      $("#editTitle").val(title)
      $("#editDeadline").val(deadline.split("T")[0])

      $("#editComplete").prop("checked", complete === true || complete === "true");


     const modal = new bootstrap.Modal(document.getElementById("editModal"));
     modal.show();
    });

    // submit edit event handler

    $("#editForm").on("submit", function (e) {
      e.preventDefault();
      const id = $("#editId").val();


      $.ajax({
        url: `/todos/${id}`,
        method: "PUT",
        data: {
          title: $("#editTitle").val(),
          deadline: $("#editDeadline").val(),
          complete: $("#editComplete").is(":checked")
        }
      }).done(function (res) {
        $("#editModal").modal("hide");

        page = 1;
        finished = false;
        $("#todoContainer").empty()
        loadTodos({sortBy: "deadline", sortMode: sortMode});
      }).fail(function (xhr, status, err) {
        console.error("XHR:", xhr.responseText);
        console.error("Status:", status);
        console.error("Error:", err);
        alert("gagal update todo")
      })

    })




    // delete event handler
    $(document).on("click", ".deleteBtn", function () {
      const id = $(this).data("id");
      const title = $(this).data("title");

      $("#deleteItem").text(title);
      $("#deleteForm").attr("action", `/todos/${id}`);

      const modal = new bootstrap.Modal(document.getElementById("deleteModal"))
      modal.show();
    })
    // Delete modal
    $("#deleteForm").on("submit", function (e) {
      e.preventDefault();

      const actionUrl = $(this).attr("action");

      $.ajax({
        url: actionUrl,
        type: "DELETE",

      })
        .done(function (res) {
          console.log("todo deleted:", res.message);
          $("#deleteModal").modal("hide");

          page = 1;
          finished = false;
          $("#todoContainer").empty();
          loadTodos({ sortBy: "deadline", sortMode: sortMode });
        })
        .fail(function (xhr, status, error) {
          const errMsg = xhr.responseJSON?.error || error;
          alert("Failed to delete todo: " + errMsg);
          console.error("delete error:", errMsg);
        });
    });



    // Initial load
    loadTodos();
  </script>
</body>

</html>