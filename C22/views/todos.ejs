<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0"><%= title %></h1>
    <a href="/users/view" class="btn btn-secondary btn-sm">
      <i class="fa fa-arrow-left"></i> Back
    </a>
  </div>

  <!-- Filter Form -->
  <form id="filterForm" class="card shadow-sm mb-4 p-3">
    <input type="hidden" name="page" value="1">
    <div class="mb-3">
      <label class="form-label">Title</label>
      <input type="text" name="string" class="form-control" placeholder="Search title">
    </div>
    <div class="mb-3">
      <label class="form-label">Deadline</label>
      <div class="d-flex align-items-center gap-2">
        <input type="date" name="startdate" class="form-control">
        <span>s.d.</span>
        <input type="date" name="enddate" class="form-control">
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label">Complete</label>
      <select name="boolean" class="form-select">
        <option value="">-select complete-</option>
        <option value="true">Yes</option>
        <option value="false">Not Yet</option>
      </select>
    </div>
    <div class="d-flex gap-2 mt-3">
      <button type="submit" class="btn btn-primary">
        <i class="fa fa-search"></i>
      </button>
      <button type="button" id="resetBtn" class="btn btn-warning">
        <i class="fa fa-refresh"></i>
      </button>
    </div>
  </form>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>No</th>
              <th>Title</th>
              <th>Complete</th>
              <th>Deadline</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="todoTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav class="mt-3">
    <ul class="pagination" id="pagination"></ul>
  </nav>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure want to delete <span id="deleteItem"></span>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <form id="deleteForm" method="POST">
          <button type="submit" class="btn btn-warning">Yes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const userId = "<%= user._id %>"; // dari server

  function loadTodos(params = {}) {
    $.get(`/todos/user/${userId}`, params, function(res) {
      // Render Table
      let rows = "";
      res.data.forEach((todo, idx) => {
        rows += `
          <tr class="${!todo.complete && new Date(todo.deadline) < new Date() ? 'table-danger' : ''}">
            <td>${res.offset + idx + 1}</td>
            <td>${todo.title}</td>
            <td>${todo.complete ? 'Done' : 'Not Yet'}</td>
            <td>${todo.deadlineFormatted}</td>
            <td>
              <button class="btn btn-sm btn-success me-1 editBtn" data-id="${todo._id}">
                <i class="fa fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger deleteBtn" data-id="${todo._id}" data-title="${todo.title}">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>`;
      });
      $("#todoTable").html(rows);

      // Render Pagination
      let pages = "";
      for (let i = 1; i <= res.totalPages; i++) {
        pages += `<li class="page-item ${res.page === i ? 'active' : ''}">
                    <a class="page-link pageBtn" href="#" data-page="${i}">${i}</a>
                  </li>`;
      }
      $("#pagination").html(pages);
    });
  }

  // Initial Load
  loadTodos();

  // Filter submit
  $("#filterForm").on("submit", function(e) {
    e.preventDefault();
    const params = $(this).serialize();
    loadTodos(params);
  });

  // Reset filter
  $("#resetBtn").click(function() {
    $("#filterForm")[0].reset();
    loadTodos();
  });

  // Pagination click
  $(document).on("click", ".pageBtn", function(e) {
    e.preventDefault();
    const page = $(this).data("page");
    const params = $("#filterForm").serialize() + "&page=" + page;
    loadTodos(params);
  });

  // Delete modal
  $(document).on("click", ".deleteBtn", function() {
    const id = $(this).data("id");
    const title = $(this).data("title");
    $("#deleteItem").text(title);
    $("#deleteForm").attr("action", `/todos/delete/${id}`);
    new bootstrap.Modal($("#deleteModal")).show();
  });
</script>
</body>
</html>
