<!DOCTYPE html>
<html>

<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    html,
    body {
      min-height: 100%;
      margin: 0;
      padding: 0;
      overflow-y: auto;
    }

    .table-responsive {
      overflow: visible !important;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">
    <h1 class="h4 mb-4"><%= title %></h1>

    <!-- Filter Form -->
    <form id="filterForm" class="card shadow-sm mb-4 p-3">
      <input type="hidden" name="page" value="1">
      <div class="mb-3">
        <label class="form-label">Title</label>
        <input type="text" name="string" class="form-control" placeholder="Search title">
      </div>
      <div class="mb-3">
        <label class="form-label">Deadline</label>
        <div class="d-flex gap-2">
          <input type="date" name="startdate" class="form-control">
          <span>s.d.</span>
          <input type="date" name="enddate" class="form-control">
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Complete</label>
        <select name="boolean" class="form-select">
          <option value="">-select complete-</option>
          <option value="true">Yes</option>
          <option value="false">Not Yet</option>
        </select>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> Filter</button>
        <button type="button" id="resetBtn" class="btn btn-warning"><i class="fa fa-refresh"></i> Reset</button>
      </div>
    </form>

    <!-- Add New Todo -->
    <form class="card shadow-sm mb-3 p-2">
      <div class="input-group">
        <input type="text" name="add" class="form-control" placeholder="Add new todo title">
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-plus"></i>
        </button>
      </div>
    </form>

    <!-- Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>No</th>
                <th>Title</th>
                <th>Complete</th>
                <th>Deadline</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="todoTable"></tbody>
          </table>
        </div>
        <!-- Spinner -->
        <div id="loading" class="text-center my-3" style="display:none;">
          <div class="spinner-border" role="status"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure want to delete <span id="deleteItem"></span>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
          <form id="deleteForm" method="POST">
            <button type="submit" class="btn btn-warning">Yes</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const userId = "<%= userId %>";
    let page = 1;
    let loading = false;
    let finished = false;

    // Load todos
    function loadTodos(params = {}) {
      if (loading || finished) return;
      loading = true;
      $("#loading").show();

      const query = $.param({ ...params, page });

      $.get(`/todos/user/${userId}?${query}`, function (res) {
        if (res.data.length === 0) {
          finished = true;
          $("#loading").hide();
          return;
        }

        let rows = "";
        res.data.forEach((todo, idx) => {
          rows += `
            <tr class="${!todo.complete && new Date(todo.deadline) < new Date() ? 'table-danger' : ''}">
              <td>${res.offset + idx + 1}</td>
              <td>${todo.title}</td>
              <td>${todo.complete ? 'Done' : 'Not Yet'}</td>
              <td>${todo.deadlineFormatted}</td>
              <td>
                <button class="btn btn-sm btn-success me-1 editBtn" 
                  data-id="${todo._id}" 
                  data-title="${todo.title}"
                  data-deadline="${todo.deadlineFormatted}"
                  data-complete="${todo.complete}">
                  <i class="fa fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger deleteBtn" 
                  data-id="${todo._id}" 
                  data-title="${todo.title}">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>`;
        });

        $("#todoTable").append(rows);
        page++;
        loading = false;
        $("#loading").hide();
      });
    }

    // Infinite scroll
    $(window).on("scroll", function () {
      if ($(window).scrollTop() + $(window).height() >= $(document).height() - 50) {
        loadTodos($("#filterForm").serialize());
      }
    });

    // Filter submit
    $("#filterForm").on("submit", function (e) {
      e.preventDefault();
      page = 1;
      finished = false;
      $("#todoTable").empty();
      loadTodos($(this).serialize());
    });

    // Reset filter
    $("#resetBtn").click(function () {
      $("#filterForm")[0].reset();
      page = 1;
      finished = false;
      $("#todoTable").empty();
      loadTodos();
    });

    // Delete modal
    $(document).on("click", ".deleteBtn", function () {
      const id = $(this).data("id");
      const title = $(this).data("title");
      $("#deleteItem").text(title);
      $("#deleteForm").attr("action", `/todos/delete/${id}`);
      new bootstrap.Modal($("#deleteModal")).show();
    });

    // Initial load
    loadTodos();
  </script>
</body>
</html>
