<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="d-flex flex-column min-vh-100">
  <div class="container flex-grow-1">

    <!-- Filter Form -->
    <form class="card shadow-sm mb-4 p-3">
      <input type="hidden" name="page" value="1">
      <div class="input-group">
        <input type="text" name="search" class="form-control" placeholder="Search by name or phone"
          value="<%= query.search || '' %>">
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-search"></i>
        </button>
        <button type="button" class="btn btn-warning"
          onclick="document.querySelector('input[name=search]').value=''; loadUsers(1);">
          <i class="fa fa-refresh"></i>
        </button>
      </div>
    </form>

    <!-- Data Table -->
    <table class="table table-bordered table-striped">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>

    <!-- Bottom Bar -->
    <footer class="bg-light text-center py-3 border-top mt-auto">
      <div class="d-flex justify-content-between align-items-center mt-3">
        <a href="/add" class="btn btn-primary">
          <i class="fa fa-plus"></i>
        </a>
        <nav>
          <ul class="pagination mb-0"></ul>
        </nav>
      </div>
    </footer>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" id="editName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Phone</label>
            <input type="text" id="editPhone" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>


  <!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-white">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="deleteMessage"></p>
        <input type="hidden" id="deleteId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentPage = 1;
    let totalPages = 1;
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    async function loadUsers(page = 1) {
      const search = document.querySelector("input[name='search']").value;
      const res = await fetch(`/users/?page=${page}&search=${encodeURIComponent(search)}`, {
        headers: { "Accept": "application/json" }
      });
      const data = await res.json();

      const tbody = document.getElementById("userTable");
      tbody.innerHTML = "";

      data.users.forEach((u, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${(page - 1) * data.limit + i + 1}</td>
            <td>${u.name}</td>
            <td>${u.phone}</td>
            <td>
              <button class="btn btn-sm btn-success me-1" onclick="editUser('${u._id}','${u.name}','${u.phone}')">
                <i class="fa fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger me-1" onclick="deleteUser('${u._id}','${u.name}')">
                <i class="fa fa-trash"></i>
              </button>
              <button class="btn btn-sm btn-warning" onclick="redirectTodos('${u._id}')">
                <i class="fas fa-sign-in-alt"></i>
              </button>
            </td>
          </tr>`;
      });

      // update pagination
      currentPage = data.page;
      totalPages = data.totalPages;

      const pagination = document.querySelector(".pagination");
      pagination.innerHTML = "";
      if (currentPage > 1) {
        pagination.innerHTML += `<li class="page-item"><a class="page-link" href="javascript:loadUsers(${currentPage - 1})">&laquo;</a></li>`;
      }
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `<li class="page-item ${currentPage === i ? "active" : ""}">
          <a class="page-link" href="javascript:loadUsers(${i})">${i}</a>
        </li>`;
      }
      if (currentPage < totalPages) {
        pagination.innerHTML += `<li class="page-item"><a class="page-link" href="javascript:loadUsers(${currentPage + 1})">&raquo;</a></li>`;
      }
    }

    // Search event
    document.querySelector("form").addEventListener("submit", (e) => {
      e.preventDefault();
      loadUsers(1);
    });

    // EDIT (buka modal)
    function editUser(id, oldName, oldPhone) {
      document.getElementById("editId").value = id;
      document.getElementById("editName").value = oldName;
      document.getElementById("editPhone").value = oldPhone;
      editModal.show();
    }

    // SUBMIT EDIT FORM
    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("editId").value;
      const name = document.getElementById("editName").value;
      const phone = document.getElementById("editPhone").value;

      const res = await fetch(`/users/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, phone })
      });
      if (res.ok) {
        editModal.hide();
        loadUsers(currentPage);
      }
    });

    // DELETE
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

// Buka modal hapus
function deleteUser(id, name) {
  document.getElementById("deleteId").value = id;
  document.getElementById("deleteMessage").textContent = `Are you sure want to delete "${name}"?`;
  deleteModal.show();
}

// Konfirmasi hapus
async function confirmDelete() {
  const id = document.getElementById("deleteId").value;
  const res = await fetch(`/users/${id}`, { method: "DELETE" });
  if (res.ok) {
    deleteModal.hide();
    loadUsers(currentPage);
  }
}

    // REDIRECT
    function redirectTodos(id) {
      window.location.href = `/todos/${id}`;
    }

    // Load pertama kali
    loadUsers();
  </script>
</body>
</html>
