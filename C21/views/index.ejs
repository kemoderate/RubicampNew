<!DOCTYPE html>
<html>

<head>
  <title><%= title %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body class="bg-light">
  <div class="container py-4">

    <% if (error_msg) { %>
      <div class="alert alert-danger">
        <%= error_msg %>
      </div>
    <% } %>

    <% if (user) { %>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <!-- avatar dan email -->
        <div class="d-flex align-items-center">
          <a href="/users/avatar" class="me-2">
            <% if (user.avatar) { %>
              <img src="/uploads/<%= user.avatar %>" alt="Avatar" class="rounded-circle" width="40" height="40">
            <% } else { %>
              <img src="/images/default-avatar.png" alt="Avatar" class="rounded-circle" width="40" height="40">
            <% } %>
          </a>
          <span class="fw-semibold"><%= user.email %></span>
        </div>

        <form action="/logout" method="POST" class="m-0">
          <button type="submit" class="btn btn-dark btn-sm">
            <i class="fa fa-sign-out"></i> Sign Out
          </button>
        </form>
      </div>
    <% } %>

    <h1 class="h3 mb-4"><%= title %></h1>

    <!-- Filter form -->
    <form action="/" method="GET" class="row g-3 mb-4">
      <input type="hidden" name="page" value="1">

      <div class="col-md-4">
        <label class="form-label">Title</label>
        <input type="text" name="string" class="form-control" placeholder="insert your name" value="<%= query.string || '' %>">
      </div>

      <div class="col-md-4">
        <label class="form-label">Deadline</label>
        <div class="d-flex align-items-center gap-2">
          <input type="date" name="startdate" class="form-control" value="<%= query.startdate || '' %>">
          <span class="mx-1">s.d.</span>
          <input type="date" name="enddate" class="form-control" value="<%= query.enddate || '' %>">
        </div>
      </div>

      <div class="col-md-2">
        <label class="form-label">Complete</label>
        <select name="boolean" class="form-select">
          <option value="">-select complete-</option>
          <option value="true" <%=query.boolean==='true' ? 'selected' : '' %>>Yes</option>
          <option value="false" <%=query.boolean==='false' ? 'selected' : '' %>>Not Yet</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Operation</label>
        <div class="d-flex gap-3">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="op" value="OR" <%=query.op==='OR' || !query.op ? 'checked' : '' %>>
            <label class="form-check-label">OR</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="op" value="AND" <%=query.op==='AND' ? 'checked' : '' %>>
            <label class="form-check-label">AND</label>
          </div>
        </div>
      </div>

      <div class="col-12 d-flex gap-2">
        <button type="submit" class="btn btn-primary">Search</button>
        <a href="/" class="btn btn-secondary">Reset</a>
      </div>
    </form>

    <!-- Table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <% const headers = [
                  {key: 'id', label: 'No'},
                  {key: 'title', label: 'Title'},
                  {key: 'complete', label: 'Complete'},
                  {key: 'deadline', label: 'Deadline'}
                ]; %>

                <% headers.forEach(h => { %>
                  <th>
                    <div class="d-flex justify-content-between align-items-center">
                      <span><%= h.label %></span>
                      <a href="<%= url %>&sort=<%= h.key %>&order=<%= query.order === 'ASC' ? 'DESC' : 'ASC' %>" 
                         class="btn btn-sm btn-outline-light ms-2">
                        <% if (query.sort === h.key) { %>
                          <% if (query.order === 'ASC') { %>
                            <i class="fa-solid fa-arrow-up"></i>
                          <% } else { %>
                            <i class="fa-solid fa-arrow-down"></i>
                          <% } %>
                        <% } else { %>
                          <i class="fa-solid fa-sort"></i>
                        <% } %>
                      </a>
                    </div>
                  </th>
                <% }) %>
                
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% data.forEach((entry, index)=> { %>
                <tr>
                  <td><%= entry.nomor_urut %></td>
                  <td style="display:none;"><%= entry.id %></td>
                  <td><%= entry.title %></td>
                  <td>
                    <% if (entry.complete) { %>
                      <span class="badge bg-success">Yes</span>
                    <% } else { %>
                      <span class="badge bg-secondary">No</span>
                    <% } %>
                  </td>
                  <td><%= entry.deadline_formatted %></td>
                  <td>
                    <div class="d-flex gap-2">
                      <form action="/edit/<%= entry.id %>" method="GET" class="m-0">
                        <button class="btn btn-sm btn-warning" title="Edit">
                          <i class="fa fa-edit"></i>
                        </button>
                      </form>
                      <form action="/delete/<%= entry.id %>" method="POST" class="m-0"
                        onsubmit="return confirmDelete('<%= entry.title %>')">
                        <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                          <i class="fa fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Bottom bar -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <a href="/add" class="btn btn-success">
        <i class="fa fa-plus"></i> Add
      </a>
      <nav>
        <ul class="pagination mb-0">
          <% if (page > 1) { %>
            <li class="page-item"><a class="page-link" href="<%= url %>&page=<%= page - 1 %>">&laquo;</a></li>
          <% } %>
          <% for (let i=1; i <= totalPages; i++) { %>
            <li class="page-item <%= page == i ? 'active' : '' %>">
              <a class="page-link" href="<%= url %>&page=<%= i %>"><%= i %></a>
            </li>
          <% } %>
          <% if (page < totalPages) { %>
            <li class="page-item"><a class="page-link" href="<%= url %>&page=<%= page + 1 %>">&raquo;</a></li>
          <% } %>
        </ul>
      </nav>
    </div>

  </div>

  <script>
    function confirmDelete(title) {
      return confirm(`Yakin mau hapus "${title}"?`);
    }
  </script>
</body>
</html>
