<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
  <i class="fas fa-angle-up"></i>
</a>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this user?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button id="confirmDelete" type="button" class="btn btn-primary">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Logout Modal-->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ready to Leave?</h5>
        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">Ã—</span>
        </button>
      </div>
      <div class="modal-body">Select Logout to end your current session.</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
        <a class="btn btn-primary" href="/logout">Logout</a>
      </div>
    </div>
  </div>
</div>

<!-- JS Scripts -->

<script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="/js/sb-admin-2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="/vendor/chart.js/Chart.min.js"></script>
<script src="/js/demo/chart-area-demo.js"></script>
<script src="/js/demo/chart-pie-demo.js"></script>


<!-- data tables -->
<script src="/js/crud.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const pictureInput = document.getElementById('picture');
    const previewContainer = document.getElementById('newPicturePreview');
    const previewImage = document.getElementById('previewImage');

    if (!pictureInput) {
      console.error('Picture input element not found!');
      return;
    }

    pictureInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();

        reader.onload = function (e) {
          previewImage.src = e.target.result;
          previewContainer.style.display = 'block';
        };

        reader.readAsDataURL(file);
      } else {
        // Reset jika user batal pilih file
        previewImage.src = '';
        previewContainer.style.display = 'none';
      }
    });
  });
</script>


<!-- script generate invoice -->
<script>
  $(document).ready(function () {
    const storedInvoice = sessionStorage.getItem('currentInvoice');
    if (storedInvoice) {
      $('#invoice').val(storedInvoice);
    } else {

      $.ajax({
        url: '/purchases/generate-invoice',
        method: 'GET',
      })
        .done(function (response) {
          $('#invoice').val(response.invoice);
          $('#time').val(formatTime(response.time)); // format it nicely
          // $('#operator').val(response.operator);
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
          console.error('FAILED generating invoice:', textStatus, errorThrown)
          alert('Failed to generate invoice')
        })

    }

    // Helper function to format date like HH:MM:SS
    function formatTime(dateString) {
      const date = new Date(dateString);

      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0'); // 0-indexed
      const day = String(date.getDate()).padStart(2, '0');

      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');

      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
  })
</script>
<!-- script untuk fill perhitungan total dan add ke table -->
<script>
  let items = [];
  $(document).ready(function () {
    if (!sessionStorage.getItem('currentInvoice')) {
      $.get('/purchases/generate-invoice')
        .done(function (response) {
          sessionStorage.setItem('currentInvoice', response.invoice);
          $('#invoice').val(response.invoice);
          $('#time').val(formatTime(response.time));
        });
    } else {
      const invoice = sessionStorage.getItem('currentInvoice');
      $('#invoice').val(invoice);
    }
    $('#barcode').change(function () {
      const barcode = $(this).val();
      if (!barcode) return resetFields();

      $.get(`/purchases/goods/${barcode}`)
        .done(function (data) {
          $('#goodsName').val(data.name);
          $('#stock').val(data.stock);
          $('#purchasePrice').val(data.purchaseprice);
          $('#qty').val(1);
          $('#totalPrice').val(data.purchaseprice);
        })
        .fail(function (xhr, status, error) {
          console.error('Failed to fetch goods:', error);
          alert('Error fetching goods data!');
        });
    })


    $('#qty').on('input', function () {
      const qty = Number($(this).val());
      const price = Number($('#purchasePrice').val());
      $('#totalPrice').val(qty * price);
    })

    $('#addItem').click(function () {
      const invoice = $('#invoice').val()
      const barcode = $('#barcode').val();
      const name = $('#goodsName').val();
      const qty = Number($('#qty').val());
      const price = Number($('#purchasePrice').val());
      const total = Number($('#totalPrice').val());
      const supplier = $('#supplier').val();
      const operator = $('input[name="operator"]').val();

      if (!barcode || qty <= 0) return alert('Select goods and enter qty');
      $.ajax({
        url: '/purchases/add-item',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          invoice,
          barcode,
          qty,
          purchaseprice: price,
          totalprice: total,
          supplier,
          operator
        })
      })
        .done(function (response) {
          if (response.success) {
            items.push({ barcode, name, qty, purchaseprice: price, totalprice: total });
            renderTable();
            updateTotalsum();
            resetFields()
          } else {
            alert('Failed to add item!')
          }
        })
        .fail(function (xhr, status, error) {
          console.error('error adding item:', error);
          alert('server error while adding item')
        })
    })

    function renderTable() {
      const tbody = $('#itemsTable');
      tbody.html('');
      if (items.length === 0) {
        tbody.append('<tr><td colspan="6" class="text-center">No items</td></tr>');
        return;
      }
      items.forEach((item, i) => {
        tbody.append(
          `<tr>
          <td>${i + 1}</td>
          <td>${item.barcode}</td>
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>${item.purchaseprice}</td>
          <td>${item.totalprice}</td>
          </tr>`
        );
      });
    }

    function updateTotalsum() {
      let sum = items.reduce((a, b) => a + b.totalprice, 0);
      $('#totalsum').val(sum);
    }

    function resetFields() {
      $('#barcode').val('');
      $('#goodsName, #stock, #purchasePrice, #qty, #totalPrice').val('')
    }

    $('#btnFinish').click(function () {
      if (items.length === 0) {
        alert('add at least one item!');
        return;
      }
      $('<input>').attr({
        type: 'hidden',
        name: 'items',
        value: JSON.stringify(items)
      }).appendTo('form');

      $('form').submit()
    })
  })
</script>